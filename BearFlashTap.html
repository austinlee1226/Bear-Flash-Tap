<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç†Šç†Šé–ƒé›»æ‰‹ Bear Flash Tap - é ˜çåŠ å¼·ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* åŸºç¤æ¨£å¼é‡ç½® */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { width: 100%; height: 100%; background-color: #1a1a2e; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        
        #game-outer { 
            width: 100%; height: 100%; max-width: 450px; max-height: 900px; 
            position: relative; display: flex; flex-direction: column; 
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .modal-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: rgba(15, 52, 96, 0.95); border: 3px solid #44cc00; border-radius: 25px;
            padding: 30px 20px; text-align: center; color: white; z-index: 1000; backdrop-filter: blur(10px);
            display: none; 
        }

        .menu-btn {
            margin-top: 15px; padding: 12px 30px; font-size: 18px; font-family: inherit;
            background: #44cc00; border: none; border-radius: 12px; color: white; cursor: pointer;
            width: 100%; transition: all 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .share-btn { background: #00d4ff !important; }
        .line-btn { background: #06C755 !important; } /* LINE ç¶ è‰² */

        #timer-text { color: #44cc00; font-family: 'Courier New', monospace; font-size: 40px; font-weight: bold; text-align: center; margin-top: 15px; }

        .header { flex: 0 0 10%; display: flex; justify-content: space-between; align-items: center; padding: 55px 25px 0 25px; color: #fff; }
        .stage { flex: 0 0 25%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .bear-avatar { font-size: 70px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        #target-num-bubble { position: absolute; bottom: 10px; background: #ff6699; color: white; padding: 2px 15px; border-radius: 20px; font-size: 20px; }

        /* ç¶²æ ¼èˆ‡å¡ç‰‡ */
        .grid-container { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 15px; padding: 25px; }
        .card { perspective: 1000px; width: 100%; height: 100%; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-face { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 38px; border-radius: 18px; backface-visibility: hidden; }
        .card-back { background: #fff; color: #333; border: 4px solid #ffcc00; transform: rotateY(180deg); }
        .card-front { background: #ffffff; color: #333; border: 4px solid #ddd; font-weight: bold; }

        .vanished { opacity: 0.1; pointer-events: none; transform: scale(0.9); }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .draw-mode .card-front { background: #4b0082 !important; border-color: #ae81ff !important; color: transparent !important; }

        /* æŠ–å‹•å‹•ç•«é‚è¼¯ */
        @keyframes card-shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-8px); border-color: #ff4d4d; }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
            100% { transform: translateX(0); }
        }
        .wrong-shake { animation: card-shake 0.2s linear; border: 4px solid #ff4d4d !important; background: #ffebee !important; }

        /* åºè™Ÿé¡¯ç¤ºå€æ¨£å¼ */
        #serial-box { background: #000; padding: 10px; border-radius: 10px; margin: 10px 0; font-family: monospace; letter-spacing: 2px; font-size: 20px; color: #ffcc00; border: 1px dashed #ffcc00; }
    </style>
</head>
<body>

<div id="game-outer">
    <div id="start-panel" class="modal-panel" style="display: block;">
        <h1 style="color:#44cc00">ç†Šç†Šé–ƒé›»æ‰‹</h1>
        <p>é»å®Œ 5 è¼ªå³å¯åƒåŠ é‘½çŸ³æŠ½ç</p>
        <button id="start-game-btn" class="menu-btn">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-over-panel" class="modal-panel">
        <h2 id="end-title" style="color: #ff4d4d;">TIME OVER!</h2>
        <p>å®Œæˆï¼š<span id="final-rounds">0</span> è¼ª</p>
        <p id="chance-text" style="color:#ffcc00; margin-top:10px;"></p>
        <button id="next-action-btn" class="menu-btn">ç¢ºå®š</button>
        <button id="main-share-btn" onclick="shareGame()" class="menu-btn share-btn">åˆ†äº«æˆ°ç¸¾</button>
    </div>

    <div id="win-panel" class="modal-panel">
        <h2 style="color: #ffcc00;">ğŸ’ æ­å–œç²çï¼</h2>
        <p>æ‚¨çš„é ˜çåºè™Ÿå¦‚ä¸‹ï¼š</p>
        <div id="serial-box">000-000-000</div>
        <button id="reward-btn" onclick="handleRewardAction()" class="menu-btn">è¤‡è£½é ˜çåºè™Ÿ</button>
        <button onclick="location.reload()" class="menu-btn share-btn">å›é¦–é </button>
    </div>

    <div id="lose-panel" class="modal-panel">
        <h2 style="color: #aaa;">æŠ½ççµæŸ</h2>
        <p>é€™æ¬¡æ²’æŠ½ä¸­é‘½çŸ³ï¼Œä¸‹æ¬¡åŠ æ²¹ï¼</p>
        <button onclick="location.reload()" class="menu-btn">å›é¦–é å†ç©ä¸€æ¬¡</button>
    </div>

    <div id="timer-text">10:00</div>
    <div class="header">
        <div style="text-align:center"><small>TOP</small><br><span id="top-val-ui">0000</span></div>
        <div id="hearts">â¤ï¸â¤ï¸â¤ï¸</div>
        <div id="score-val" style="display:none">0000</div>
    </div>
    
    <div class="stage" id="bear-stage">
        <div id="draw-chance-info" style="color:#00d4ff; font-weight:bold;"></div>
        <div class="bear-avatar">ğŸ»</div>
        <div id="target-num-bubble">Next: 1</div>
    </div>

    <div id="card-grid" class="grid-container"></div>
</div>

<script>
    let audioCtx = null;
    function initAudio() { try { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
    function playSound(freq, type, duration) {
        if (!audioCtx) return;
        try {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }

    const CONFIG = { INIT_TIME: 10.0, WRONG_PENALTY: 1.5, CORRECT_BONUS: 0.3, BONUS_THRESHOLD: 5 };
    let state = { currentTime: 10.0, score: 0, lives: 3, nextNum: 1, rounds: 0, isPlaying: false, isDrawPhase: false, drawChances: 0, hasWon: false };

    const dom = {
        grid: document.getElementById('card-grid'),
        timer: document.getElementById('timer-text'),
        bubble: document.getElementById('target-num-bubble'),
        chanceInfo: document.getElementById('draw-chance-info'),
        endPanel: document.getElementById('game-over-panel'),
        actionBtn: document.getElementById('next-action-btn'),
        shareBtn: document.getElementById('main-share-btn'),
        rewardBtn: document.getElementById('reward-btn'),
        serialBox: document.getElementById('serial-box'),
        topVal: document.getElementById('top-val-ui'),
        cards: []
    };

    function initGrid(count = 9) {
        dom.grid.innerHTML = ''; dom.cards = [];
        for (let i = 0; i < count; i++) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-inner" style="width:100%;height:100%"><div class="card-face card-front"></div><div class="card-face card-back"></div></div>`;
            const handler = (e) => { e.preventDefault(); if (state.isPlaying) handleTap(i); else if (state.isDrawPhase) handlePickCard(i); };
            card.addEventListener('mousedown', handler);
            card.addEventListener('touchstart', handler, {passive: false});
            dom.grid.appendChild(card);
            dom.cards.push(card);
        }
    }

    function shuffleRound() {
        state.nextNum = state.rounds + 1;
        dom.bubble.textContent = `Next: ${state.nextNum}`;
        const shuffled = Array.from({length: 9}, (_, i) => state.nextNum + i).sort(() => Math.random() - 0.5);
        shuffled.forEach((num, i) => {
            dom.cards[i].querySelector('.card-front').textContent = num;
            dom.cards[i].classList.remove('vanished', 'is-flipped');
        });
    }

    function handleTap(index) {
        const card = dom.cards[index];
        const val = parseInt(card.querySelector('.card-front').textContent);
        if (val === state.nextNum) {
            playSound(880, 'sine', 0.1);
            card.classList.add('vanished');
            state.score += 10; state.nextNum++;
            state.currentTime = Math.min(15, state.currentTime + CONFIG.CORRECT_BONUS);
            if (state.nextNum > (state.rounds + 1 + 8)) {
                state.rounds++;
                if (state.rounds % 5 === 0) confetti({ particleCount: 100 });
                shuffleRound();
            } else { dom.bubble.textContent = `Next: ${state.nextNum}`; }
        } else {
            // é»éŒ¯æŠ–å‹•é‚è¼¯
            playSound(150, 'sawtooth', 0.2);
            card.querySelector('.card-front').classList.add('wrong-shake');
            setTimeout(() => card.querySelector('.card-front').classList.remove('wrong-shake'), 300);
            
            state.currentTime -= CONFIG.WRONG_PENALTY; state.lives--; updateHearts();
            if (state.lives <= 0) endGame();
        }
    }

    function startDrawPhase() {
        dom.endPanel.style.display = 'none';
        state.isDrawPhase = true;
        dom.bubble.style.display = 'none';
        dom.grid.classList.add('draw-mode');
        initGrid(9);
        const diamondIndex = Math.floor(Math.random() * 9);
        dom.cards.forEach((card, i) => {
            card.querySelector('.card-back').textContent = (i === diamondIndex) ? 'ğŸ’' : 'ğŸ»';
            card.dataset.isDiamond = (i === diamondIndex);
        });
        dom.chanceInfo.textContent = `å‰©é¤˜ç¿»ç‰Œæ¬¡æ•¸: ${state.drawChances}`;
    }

    async function handlePickCard(index) {
        const card = dom.cards[index];
        if (card.classList.contains('is-flipped') || state.drawChances <= 0) return;
        state.drawChances--;
        dom.chanceInfo.textContent = `å‰©é¤˜ç¿»ç‰Œæ¬¡æ•¸: ${state.drawChances}`;
        card.classList.add('is-flipped');
        if (card.dataset.isDiamond === "true") { state.hasWon = true; playSound(1200, 'sine', 0.4); }
        else { playSound(400, 'sine', 0.2); }

        if (state.drawChances <= 0) {
            state.isDrawPhase = false;
            await new Promise(r => setTimeout(r, 1000));
            dom.cards.forEach(c => c.classList.add('is-flipped'));
            await new Promise(r => setTimeout(r, 1500));
            if (state.hasWon) {
                fireWinnerUI();
            } else {
                document.getElementById('lose-panel').style.display = 'block';
            }
        }
    }

    // ç”Ÿæˆä¸¦é¡¯ç¤ºç²ç UI
    function fireWinnerUI() {
        confetti({ particleCount: 200, spread: 100 });
        // ç”Ÿæˆä¹ä½æ•¸åºè™Ÿ XXX-XXX-XXX
        const rand = () => Math.floor(100 + Math.random() * 900);
        const serial = `${rand()}-${rand()}-${rand()}`;
        dom.serialBox.textContent = serial;
        document.getElementById('win-panel').style.display = 'block';
    }

    // è™•ç†é ˜çæŒ‰éˆ•çš„å…©æ®µå¼åˆ‡æ›
    function handleRewardAction() {
        const serialText = dom.serialBox.textContent;
        // åŸ·è¡Œè¤‡è£½
        navigator.clipboard.writeText(serialText).then(() => {
            alert("åºè™Ÿå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            // è®Šæ›æŒ‰éˆ•
            dom.rewardBtn.textContent = "å‰å¾€ LINE é ˜ç";
            dom.rewardBtn.classList.add('line-btn');
            dom.rewardBtn.onclick = () => {
                // é€™è£¡å¯ä»¥æ”¾å…¥ LINE é€£çµï¼Œä¾‹å¦‚ window.location.href = "https://line.me/R/ti/p/@yourid";
                console.log("å°å‘ LINE...");
            };
        });
    }

    let loop = null;
    function startGame() {
        initAudio(); state.isPlaying = true; state.currentTime = CONFIG.INIT_TIME;
        state.score = 0; state.lives = 3; state.rounds = 0; state.hasWon = false;
        dom.bubble.style.display = 'block';
        dom.grid.classList.remove('draw-mode');
        dom.chanceInfo.textContent = "";
        updateHearts(); initGrid(9); shuffleRound();
        let last = Date.now();
        loop = setInterval(() => {
            if (!state.isPlaying) { last = Date.now(); return; }
            let now = Date.now(); state.currentTime -= (now - last) / 1000; last = now;
            if (state.currentTime <= 0) { state.currentTime = 0; endGame(); }
            let s = Math.floor(state.currentTime); let ms = Math.floor((state.currentTime % 1) * 100);
            dom.timer.textContent = `${s}:${ms.toString().padStart(2, '0')}`;
        }, 50);
    }

    function updateHearts() { document.getElementById('hearts').textContent = 'â¤ï¸'.repeat(state.lives) + 'ğŸ–¤'.repeat(3 - state.lives); }

    function endGame() {
        state.isPlaying = false; clearInterval(loop);
        document.getElementById('final-rounds').textContent = state.rounds;
        state.drawChances = Math.floor(state.rounds / 5);
        dom.endPanel.style.display = "block";
        if (state.drawChances > 0) {
            document.getElementById('end-title').textContent = "æŒ‘æˆ°æˆåŠŸï¼";
            document.getElementById('chance-text').textContent = `ç²å¾— ${state.drawChances} æ¬¡ç¿»ç‰Œæ©Ÿæœƒï¼`;
            dom.actionBtn.textContent = "é€²å…¥é‘½çŸ³æŠ½ç";
            dom.actionBtn.onclick = startDrawPhase;
            dom.shareBtn.style.display = "none";
        } else {
            document.getElementById('end-title').textContent = "æ™‚é–“åˆ°ï¼";
            document.getElementById('chance-text').textContent = `æ»¿ 5 è¼ªå³å¯åƒåŠ æŠ½ç`;
            dom.actionBtn.textContent = "é‡æ–°æŒ‘æˆ°";
            dom.actionBtn.onclick = () => location.reload();
            dom.shareBtn.style.display = "block";
        }
    }

    function shareGame() {
        const text = `æˆ‘åœ¨ã€Šç†Šç†Šé–ƒé›»æ‰‹ã€‹å®Œæˆ ${state.rounds} è¼ªæŒ‘æˆ°ï¼å¿«ä¾†æ¯”æ¯”çœ‹èª°æ›´å¼·ï¼`;
        if (navigator.share) navigator.share({ title: 'ç†Šç†Šé–ƒé›»æ‰‹', text: text, url: window.location.href });
        else alert("å·²è¤‡è£½ï¼š\n" + text);
    }

    document.getElementById('start-game-btn').onclick = () => { document.getElementById('start-panel').style.display = 'none'; startGame(); };
    initGrid(9);
</script>
</body>
</html>